Описание
========

Пакет предназначен для развертывания на Ubuntu 20.04 (Focal Fossa)

Рекомендуется использовать "чистую" ОС с утановленными обновлениями и драйверами (install third-party software for graphics and Wi-Fi harware and additional media formats)

Для своей работы использует:
- библиотеки и окружение ROS Noetic (https://www.ros.org)
- программный пакет 3D симуляции и моделирования Gazebo (http://gazebosim.org)
- код открытого автопилота PX4 (https://px4.io)

Содержит:
- скрипты запуска симуляции в Gazebo
- модели объектов и описание миров для Gazebo
- примеры кода для запуска группы аппаратов
- служебные файлы и исполняемые скрипты

Минимальные требования к оборудованию : CPU Intel Core i7 4770, RAM 8Гб, Nvidia GTX650 1Гб


Подготовка к установке
======================

Установка Git

```
sudo apt install git
```

Скачивание репозитория

```
git clone https://github.com/acsl-mipt/drone-games.git
```

Переход в скачанный репозиторий

```
cd drone-games/
```

Обновление локального репозитория (получение изменений из удаленного репозитория; команда выполняется из директории drone-games)

```
git pull
```


Установка
=========

Для установки всех зависимостей и компиляции (сборки) необходимых файлов:

```
./install.sh
```

Если в системе уже установлены все зависимости:

```
./install.sh build
```

После установки необходимо перезапустить терминал для продолжения работы (закрыть и открыть новый)


Проверка работоспособности
==========================

Запуск с моделью аппарата iris в количестве 1 шт.:

```
./start.sh iris 1
```

После успешного выполнения скрипта вы должны увидеть следующее:

![Start](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/start.png)


Отановка

```
./stop.sh
```

Помощь по имеющимся аргументам командной строки:

```
./start.sh iris 1 --help
```

Работа с группой аппаратов
==========================

Пример с коптерами:

```
./test-group.sh
```

Пример с планерами вертикального взлета и посадки (VTOL):

```
./test-group.sh vtol
```

Синхронный полет
================

### Описание дисциплины

В рамках дисциплины «Синхронный полет» задача Команды разработать и запрограммировать алгоритм, позволяющий группе беспилотных аппаратов преодолеть гоночную трассу, выстраиваясь перед трибунами зрителей в геометрические формации различной сложности. Оценивается точность поддержания формации и время прохождения всей трассы.

### Группа беспилотных аппаратов

Группа беспилотных аппаратов состоит из одинаковых аппаратов в количестве от 12 до 30 штук. 

Аппараты являются цифровыми двойниками реальных моделей беспилотных летательных аппаратов двух типов: 

* мультироторный (квадрокоптер);
* самолетный (планер вертикального взлета и посадки).

### Гоночная трасса

Гоночная трасса представляет собой спортивный стадион. 

![Formation_1](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/1.png)

Полет группы аппаратов осуществляется над беговыми дорожками по направлению против часовой стрелки. Место старта находится за правыми футбольными воротами.

![Formation_2](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/2.png)

Зоны пролета - части беговых дорожек, отмеченные зеленым цветом.

Над зонами пролета группа аппаратов должна двигаться поддерживая формацию (взаимное пространственное расположение) в соответствии с полученным заданием.

Размеры зон пролета: длина 124 метров, ширина 20 метров, высота 50 метров.

Зоны перестроения - части беговых дорожек, отмеченные желтым цветом.

Пролетая над зонами перестроения группа аппаратов должна перестроится в новую формацию в соответствии с полученным заданием.

Размеры зон перестроения: длина 102 метра, ширина 20 метров, высота 50 метров.

Центры зон пролета расположены по следующим координатам: (41; 0) и (-41; 0), зон перестроения: (0; 72) и (0; -72).

![Formation_3](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/3.png)

Над стадионом введено ограничительное пространство со следующими размерами: длина 214 метров, ширина 148 метров, высота 100 метров, не позволяющее вылететь за пределы (-74; 74) по X, (-107; 107) по Y, (0; 100) по Z.

Ограничительное пространство введено для того чтобы аппараты при нештатных ситуациях не разлетались на большие расстояния. Для аппаратов ограничительное пространство является непроходимой стеной и на нем работает механизм упругого столкновения.

### Симулятор

Симулятор является виртуальной средой моделирования в реальном времени полета группы беспилотных аппаратов и создан на базе:

* библиотеки и окружения ROS Noetic (https://www.ros.org)
* программного пакет 3D симуляции и моделирования Gazebo (http://gazebosim.org)
* открытого код автопилота PX4 (https://px4.io)

### Системы координат

В Симуляторе используется следующие системы координат:

* локальная система координат (точка отсчета соответствует месту включения аппарата)
* глобальная система координат (с началом отсчета в центре стадиона на уровне земли)

и следующие базисы:

* ENU(Восток-Север-Вверх) для ROS/Mavros
* NED(Север-Восток-Вниз) для автопилота PX4 и сообщений Mavlink

Обратите внимание, что точкой (0; 0) в локальной системе координат аппарат считает ту точку, что вы передали в опции --ref_point. То есть она вовсе не обязательно должна совпадать с нулем среды симуляции.

### Алгоритм управления

Управление каждым аппаратом в группе происходит с помощью централизованного алгоритма, разрабатываемого Командой. 

Управляющие воздействия на аппараты выдаются в одном из следующих вариантов:

* по точкам в локальной системе координат (ENU) для мультироторов;
* по скоростям в локальной системе координат (ENU) для мультироторов;
* по скоростям в плоскости и заданию высоты в локальной системе координат (ENU) для самолетов.

Алгоритмы должны быть или уникальными или иметь принципиальные отличия от общедоступных. Работоспособность алгоритмов будет оцениваться автоматизировано, при помощи системы автоматического судейства встроенной в Симулятор и при презентации алгоритма Экспертам.

С примером реализации алгоритма управления вы можете ознакомиться в файле `examples/group.py`.

### Запуск

Для запуска Симулятора выполните команду

```
./formation.sh
```

После успешного выполнения скрипта вы должны увидеть следующее:

![Formation](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/formation.png)

### Формации

Формации представляют собой совокупность точек пространства, в каждой из которых должен находиться один аппарат из группы. При этом любой аппарат группы может занимать любую точку.

Формации задаются в относительных координатах ENU, например, построение в виде буквы «Т» из шести аппаратов будет задано в таком виде: (0, -3, 11), (0, -1, 11), (0, 1, 11), (0, 3, 11), (0, 0, 8), (0, 0, 5).

При запуске скрипта `./formation.sh` также запускается ROS-нода, публикующая в ROS-топик `/formations_generator/formation` текущие относительные координаты для построения формации в формате `std_msgs.msg.String`: `"НАЗВАНИЕ_ФОРМАЦИИ КООРДИНАТА_X_1 КООРДИНАТА_Y_1 КООРДИНАТА_Z_1 КООРДИНАТА_X_2 КООРДИНАТА_Y_2 КООРДИНАТА_Z_2 ..."`. Для тестового задания формаций четыре: 

* первая формация - буква Т: (0, -3, 11), (0, -1, 11), (0, 1, 11), (0, 3, 11), (0, 0, 8), (0, 0, 5)
* вторая - Е: (0, 0, 11), (0, 3, 11), (0, 0, 8), (0, 3, 8), (0, 0, 5), (0, 3, 5)
* третья - С: (0, 1, 9), (0, 0, 11), (0, -2, 9), (0, -2, 7), (0, 0, 5), (0, 1, 6) 
* четвертая - снова "Т"

Координаты текущей требуемой формации публикуются в вышеназванный ROS-топик. В тот момент, когда один из аппаратов переходит из зоны пролета в зону перестроения, начинают публиковаться новые относительные координаты. Обратите внимание, что координаты являются относительными (система координат - "вправо-вперед-вверх", аналог ENU).

Виды формации, выносимые на Соревнования, и количество аппаратов для их построения заранее не известны.

### Задание

Задача Команды разработать алгоритм управления группой аппаратов, который автоматически:

* распределит месторасположение аппаратов в каждой из формаций;
* выдаст управляющие воздействия на аппараты для поддержания формаций;
* выдаст управляющие воздействия на аппараты для перестроения между формациями;
* выдаст управляющие воздействия на аппараты для перемещения по гоночной трассе для выполнения полного полетного задания.

#### Для Любительской лиги:

При запуске Симулятора автоматически выдается полное полетное задание в виде последовательности и набора необходимых для выполнения формаций. В каждой зоне пролета (до выхода из нее) должна поддерживаться одна формация согласно полученному полетному заданию. После чего в зоне перестроения должно быть выполнено перестроение в следующую по полетному заданию формацию и ее поддержание в ближайшей зоне пролета по направлению движения (показано стрелками).

![Formation_4](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/4.png)

#### Для Профессиональной лиги:

При запуске Симулятора автоматически выдается полетное задание в виде необходимой для выполнения формаций в ближайшей зоне пролета по направлению движения (показано стрелками). В тот момент, когда один из аппаратов переходит из зоны пролета в зону перестроения (красные линии), публикуется следующая необходимая для выполнения формаций в ближайшей зоне пролета по направлению движения.

### Определение победителя

Оценивается точность поддержания формации и время прохождения всей трассы. Побеждает команда, набравшая больше число баллов.

Баллы начисляются или снимаются согласно Методологии за следующие действия:

* точность поддержания формации в зонах пролета (за каждую формацию);
* время поддержания формации в зонах пролета (за каждую формацию);
* время преодоления зон перестроения (за каждую зону);
* количество аппаратов вылетевших за рамки зон пролета и перестроения;
* время нахождения аппаратов вне зон пролета и перестроения;
* столкновения аппаратов.

Подробное описание Методологии начисления балов будет доступно 12 апреля 2021 года.

Количество призовых мест и распределение призового фонда осуществляется на усмотрение организаторов и партнеров. В спорных ситуациях решение остается за организаторами.

Тестовое окружение симулятора
=============================

#### Командная гонка

Запуск:

```
./race.sh
```

После успешного выполнения скрипта вы должны увидеть следующее:

![Race](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/race.png)

