Командная гонка (тестовое задание)
==================================

### Описание дисциплины

В рамках дисциплины «Командная гонка» задача Команды разработать и продемонстрировать работоспособность алгоритма, позволяющего группе беспилотных аппаратов преодолеть многосекционный лабиринт, разделенный перегородками с отверстиями. 

### Группа беспилотных аппаратов

В тестовом задании группа беспилотных аппаратов состоит из одинаковых аппаратов в количестве 6 штук.

Аппараты являются цифровыми двойниками реальных моделей беспилотных летательных аппаратов двух типов: 

* мультироторный (квадрокоптер);
* самолетный (планер вертикального взлета и посадки).

### Гоночная трасса

Гоночная трасса представляет собой многосекционный лабиринт, разделенный перегородками с отверстиями. 

![Race_1](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/5.png)

Полет группы аппаратов осуществляется по лабиринту начиная с площадки взлета (отмечено знаком Н) до посадочной площадки (отмечено Х).

![Race_2](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/6.png)

Поперечные размеры лабиринта 20 на 20 метров, длина и конфигурация лабиринта зависит от количества перегородок и заранее не известна.

![Race_3](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/7.png)

Перегородки в лабиринте содержат разноформатные сквозные отверстия через которые необходимо пролетать перестраивая группу аппаратов. На примере изображена перегородка с отверстиями в виде стилизованной буквы Т. Количество и конфигурация отверстий в перегородке заранее не известно.

![Race_4](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/8.png)

Отверстия в перегородках задаются в формате:

```
x1 y1 w1 h1 x2 y2 w2 h2 ... xN yN wN hN
```

где `x` и `y` относительные координаты центра отверстия от центра перегородки (в системе отсчета Право-Верх, если смотреть по ходу движения), `w` - ширина отверстия, а `h` – высота отверстия.

Например, перегородка с отверстиями в виде стилизованной буквы Т задается следующими значениями:

одной строкой `0 -1 2 6 0 4 6 2`

или несколькими строками по 4 числа:

`0 -1 2 6`

`0 4 6 2`

Перегородки могут содержать отверстия, в которые отдельно взятый аппарат не может пролететь из-за габаритных ограничений, поэтому в алгоритме управления необходимо будет делать проверку для исключения таких отверстий из маршрута полета группы.

Минимальное расстояние между перегородками 40 метров.

Стены, пол и потолок лабиринта являются непроходимой преградой для аппаратов и на них работает механизм упругого столкновения.

### Центральная линия

Для передачи конфигурации лабиринта между перегородками используется механизм центральных линий. Центральная линия – это виртуальная линия, длины перпендикуляров от которой к стенам, полу и потолку лабиринта равны. 

Центральная линия задается строкой, содержащей координаты произвольного количества точек, разделенных пробелами: 

```
x1 y1 z1 x2 y2 z2 ... xN yN zN
```

Точки задают отрезки, из которых составлена центральная линия. Каждая центральная линия последним отрезком упирается в стену с отверстиями и перпендикулярна ей, последняя центральная линия упирается в глухую стену.

![Race_5](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/9.png)

Например, заданная следующей строкой центральная линия:
`90 0 10 120 0 10 120 30 10`
состоит из трех опорных точек в локальной системе координат Симулятора с координатами A (90;0;10), B (120;0;10) и C (120;30;10). В крайних точках (A и C) расположены центры перегородок.

### Системы координат

В Симуляторе используются следующие системы координат:

* локальная система координат автопилота (точка отсчета соответствует месту включения аппарата, опция --ref_point в скрипте запуска)
* локальная система координат Симулятора (с началом отсчета в центре стадиона на уровне земли)

и следующие базисы:

* ENU (Восток-Север-Вверх) для локальной системы координат Симулятора, сообщений ROS/Mavros
* NED (Север-Восток-Вниз) для автопилота PX4 и сообщений Mavlink

Все координаты объектов в текущем документе заданы в локальной системе координат Симулятора.
Обратите внимание, что точкой (0,0) в локальной системе координат автопилота аппарат считает ту точку, которую вы передали в опции --ref_point в локальной системе координат Симулятора.
Так же следует отметить: несмотря на то, что автопилот работает в базисе NED, при обмене с ним с помощью Mavros, базисы систем координат автопилота и Симулятора становятся одинаковыми (ENU). То есть, если вы не использовали опцию --ref_point, локальные системы координат автопилота и Симулятора фактически совпадают.

### Алгоритм управления

Управление каждым аппаратом в группе происходит с помощью централизованного алгоритма, разрабатываемого Командой.

Управляющие воздействия на аппараты выдаются в одном из следующих вариантов:

* по точкам в локальной системе координат (ENU) для мультироторов и самолетов;
* по скоростям в локальной системе координат (ENU) для мультироторов;
* по скоростям в плоскости и заданию высоты в локальной системе координат (ENU) для самолетов.

Алгоритмы должны быть или уникальными или иметь принципиальные отличия от общедоступных. Работоспособность алгоритмов будет оцениваться автоматизировано, при помощи системы автоматического судейства встроенной в Симулятор.

С примером реализации алгоритма управления вы можете ознакомиться в файле `examples/group.py`.

### Формации

Формации представляют собой совокупность точек пространства, в каждой из которых должен находиться один аппарат группы. При этом где находится какой из аппаратов группы задается алгоритмом, разработанным участником соревнований. Какой вид и пространственную конфигурацию формации использовать для прохождения каждой из перегородок должно рассчитываться в алгоритме управления группой, исходя из анализа расположения отверстий в перегородках между секциями лабиринта.

### Запуск

Для запуска Симулятора выполните команду

```
./race.sh РЕЖИМ
```
В качестве режима указывать `nonprof` - для Любительской лиги и `prof` - для Профессиональной.

После успешного выполнения скрипта вы должны увидеть следующее:

![Race](https://github.com/acsl-mipt/drone-games/blob/main/.imgs/race.png)

### Задание

Задача Команды разработать алгоритм управления группой аппаратов, который автоматически:

* проанализирует расположение отверстий в перегородках между секциями лабиринта;
* распределит месторасположение аппаратов в каждой из формаций для оптимального пролета через отверстия в каждой из перегородок;
* выдаст управляющие воздействия на аппараты для поддержания формаций;
* выдаст управляющие воздействия на аппараты для перестроения между формациями;
* выдаст управляющие воздействия на аппараты для перемещения по гоночной трассе с площадки взлета до посадочной площадки преодолевая перегородки.

#### Для Любительской лиги:

Полное полетное задание известно заранее и находится в папке race:

* в файле `race/centrals.txt` хранится последовательность центральных линий в виде набора строк, каждая строка описывает маршрут до ближайшей перегородки (кроме последней);
* в папке `race/test_ws/` размещен каталог с файлами, содержащими строки из 4 чисел, разделенных пробелами и описывающими отверстия в перегородках.

#### Для Профессиональной лиги:

При запуске Симулятора автоматически выдается полетное задание в виде центральной линии и параметров отверстий в ближайшей перегородке. Как только любой из аппаратов группы пролетает сквозь перегородку, происходит выдача следующей центральной линии и параметров отверстий в следующей перегородке.

Топики: 

* `/path_generator/central`
* `/path_generator/walls`

Формат строки топиков: значения разделены пробелами

```
central: ИМЯ_СТЕНЫ x1 y1 z1 x2 y2 z2 ... xN yN zN
```

Имя означает стену, на которой заканчивается эта центральная линия.

```
walls: ИМЯ_СТЕНЫ x1 y1 w1 h1 x2 y2 w2 h2 ... xN yN wN hN
```

Если центральная линия последняя, в central вместо имени используется символ `|`, а в walls ничего не публикуется.

#### Определение отобранных команд

Команды, которые успешно смогут выполнить тестовое задние до 12 апреля (включительно) проходят в финальную часть соревнований.

